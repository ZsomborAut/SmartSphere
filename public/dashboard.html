<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SmartHome</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background-color: black;
      /* alap h√°tt√©rsz√≠n bet√∂lt√©s k√∂zben */
      background-image: url("images/bckgnd-Modern House.jpg");
      background-size: cover;
      background-position: center 23%;
      background-repeat: no-repeat;
      background-attachment: fixed;
      font-family: Arial, sans-serif;
    }

    body.outside {
      margin: 0;
      height: 100vh;
      background-image: url("images/bckgnd-Modern House.jpg");
      background-size: cover;
      background-position: center 23%;
      background-repeat: no-repeat;
      font-family: Arial, sans-serif;
    }

    body.inside {
      background-image: url("images/bckg-House Plan.jpg");
      background-size: cover;
      background-position: 60% 40%;
      background-repeat: no-repeat;
    }

    /* K√∂r gomb */
    .btn-circle {
      position: absolute;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: 5px solid rgb(0, 0, 100);
      background: radial-gradient(circle at 30% 30%, rgba(0, 255, 255, 0.133), rgba(0, 0, 0, 0.267));
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.333);
      cursor: pointer;
      transition: box-shadow 0.25s ease, transform 0.25s ease, border-color 0.25s ease;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Hoverre csak f√©nyesebb lesz, nem forog */
    .btn-circle:hover {
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.667), 0 0 50px rgba(0, 255, 255, 0.333) inset;
      transform: scale(1.1);
    }

    .btn-circle .auto-label {
      opacity: 1 !important;      /* Mindig l√°that√≥, ha nincs hidden oszt√°ly */
      transform: none !important;  /* Ne mozogjon hoverkor */
      background: black;
      color: yellow;
      font-size: 14px;
      top: 50px;
      right: -30px;
    }

    /* Ikon a k√∂zep√©n */
    .btn-circle img {
      width: 70%;
      height: 70%;
      object-fit: contain;
      pointer-events: none;
    }

    /* Tooltip (felirat) */
    .btn-circle span {
      position: absolute;
      left: auto;
      right: 50px;
      top: 50%;
      transform: translateY(-50%) translateX(-10px);
      color: rgb(0, 255, 255);
      font-size: 16px;
      background: rgb(0, 0, 0);
      padding: 4px 10px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.25s ease, transform 0.25s ease;
      pointer-events: none;
      white-space: nowrap;
    }

    /* Hoverkor megjelenik a felirat */
    .btn-circle:hover span {
      opacity: 1;
      transform: translateY(-50%) translateX(0);
    }

    .hidden {
      display: none;
    }

    .btn-circle.tooltip-left span {
      left: 60px;
      right: auto;
      transform: translateY(-50%) translateX(-10px);
    }

    #Settings {
      top: 1%;
      right: 1%;
    }

    #Garage {
      top: 55%;
      right: 16%;
    }

    #Entrence {
      top: 54%;
      right: 48.5%;
    }

    #Watering {
      bottom: 10%;
      right: 35%;
    }

    #Roller_Shutter {
    position: absolute;
    top: 35%;
    left: 47.5%;
    }

    #Gate {
      bottom: 10%;
      left: 9%
    }

    #Security {
      top: 10%;
      right: 48.5%
    }

    #External_Lighting {
      bottom: 25.5%;
      left: 25%
    }

    /* I N T E R I O R */

    /*Lighting*/
    #Living_Lighting {
      top: 35%;
      left: 65%
    }

    #Bedroom03_Lighting {
      bottom: 25%;
      left: 53%
    }

    #Bedroom04_Lighting {
      bottom: 25%;
      left: 30%
    }

    #Kitchen_Lighting {
      top: 30%;
      left: 55%
    }

    #Bathroom_Lighting {
      bottom: 22%;
      left: 41%
    }

    #Toalett_Lighting {
      bottom: 42%;
      left: 43%
    }

    #Garage_Lighting {
      top: 28%;
      left: 25%
    }

    #Heating {
      bottom: 42%;
      left: 19%;
    }

    #Back {
      bottom: 2%;
      left: 1%
    }

    /* vil√°g√≠t√≥ √°llapot st√≠lusa ‚Äì nagyobb f√©nyk√∂rrel */
    .btn-circle.active {
      border-color: rgb(0, 200, 0);
      box-shadow:
        0 0 35px rgba(0, 255, 0, 0.8),
        /* er≈ësebb k√∂zeli f√©ny */
        0 0 50px rgba(0, 255, 0, 0.5) inset,
        /* bels≈ë ragyog√°s */
        0 0 120px rgba(0, 255, 0, 0.4),
        /* k√ºls≈ë f√©ny */
        0 0 200px rgba(0, 255, 0, 0.25);
      /* t√°volabbra sz√≥rt halv√°ny f√©ny */
    }

    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .disabled .auto-label {
      opacity: 1 !important;
      pointer-events: auto !important;
    }
  </style>
</head>

<body>
  <div class="btn-circle" id="Settings">
    <img src="images/Settings.png" alt="Settings">
    <span>Settings</span>
  </div>

  <div class="btn-circle" id="Garage">
    <img src="images/Garage.png" alt="Garage">
    <span>Garage</span>
  </div>

  <div class="btn-circle" id="Entrence">
    <img src="images/Entrence.png" alt="Entrence">
    <span>Entrence</span>
  </div>

  <div class="btn-circle" id="Watering">
    <img src="images/Watering.png" alt="Watering">
    <span>Watering</span>
  </div>

  <div class="btn-circle" id="Roller_Shutter">
    <img src="images/Roller_Shutter.png" alt="RollerShutter">
    <span>Roller Shutter</span>
    <span class="auto-label hidden"
        style="position:absolute; top:40px; right:-30px; color:yellow; font-size:14px;">
    Auto
  </span>
  </div>

  <div class="btn-circle" id="Gate">
    <img src="images/Gate.png" alt="Gate">
    <span>Gate</span>
  </div>

  <div class="btn-circle" id="Security">
    <img src="images/Security.png" alt="Security">
    <span>Security</span>
  </div>

  <div class="btn-circle" id="External_Lighting">
    <img src="images/Light.png" alt="ExternalLighting">
    <span>External Lighting</span>
  </div>

  <div class="btn-circle hidden tooltip-left" id="Back">
    <img src="images/Back.png" alt="Back">
    <span>Back</span>
  </div>

  <div class="btn-circle hidden tooltip-left" id="Living_Lighting">
    <img src="images/Light.png" alt="Living_Lighting">
    <span>Living Lighting</span>
  </div>

  <div class="btn-circle hidden tooltip-left" id="Bedroom03_Lighting"> <!--Innen kell vegyem a mintat-->
    <img src="images/Light.png" alt="Bedroom03_Lighting">
    <span>Bedroom03 Lighting</span>
  </div>

  <!--Innen irtam-->
  <div class="btn-circle hidden tooltip-left" id="Bedroom04_Lighting">
    <img src="images/Light.png" alt="Bedroom04_Lighting">
    <span>Bedroom04 Lighting</span>
  </div>

  <div class="btn-circle hidden tooltip-left" id="Kitchen_Lighting">
    <img src="images/Light.png" alt="Kitchen_Lighting">
    <span>Kitchen Lighting</span>
  </div>

  <div class="btn-circle hidden tooltip-left" id="Bathroom_Lighting">
    <img src="images/Light.png" alt="Bathroom_Lighting">
    <span>Bathroom Lighting</span>
  </div>

  <div class="btn-circle hidden tooltip-left" id="Garage_Lighting">
    <img src="images/Light.png" alt="Garage_Lighting">
    <span>Garage Lighting</span>
  </div>

  <div class="btn-circle hidden tooltip-left" id="Toalett_Lighting">
    <img src="images/Light.png" alt="Toalett_Lighting">
    <span>Toalett Lighting</span>
  </div>

  <div class="btn-circle hidden tooltip-left" id="Heating">
    <img src="images/heating.png" alt="Heating">
    <span>Heating</span>
  </div>

  <!--Idaig-->


  <script>

    function saveUserState() {
      console.log("Saving user state...");
    }

    const Settings = document.getElementById("Settings");
    const Garage = document.getElementById("Garage");
    const Entrence = document.getElementById("Entrence");
    const Watering = document.getElementById("Watering");
    const Roller_Shutter = document.getElementById("Roller_Shutter");
    const Gate = document.getElementById("Gate");
    const Security = document.getElementById("Security");
    const External_Lighting = document.getElementById("External_Lighting");
    const Back = document.getElementById("Back");
    const Living_Lighting = document.getElementById("Living_Lighting");
    const Bedroom03_Lighting = document.getElementById("Bedroom03_Lighting");
    const Bedroom04_Lighting = document.getElementById("Bedroom04_Lighting");
    const Kitchen = document.getElementById("Kitchen_Lighting");
    const Bathroom = document.getElementById("Bathroom_Lighting");
    const Garage_Lighting = document.getElementById("Garage_Lighting");
    const Toalett = document.getElementById("Toalett_Lighting");
    const Heating = document.getElementById("Heating");

    const securityControllableButtons = [Garage, Watering, Roller_Shutter, Gate, External_Lighting, Living_Lighting, Bedroom03_Lighting, Bedroom04_Lighting, Kitchen, Bathroom, Garage_Lighting, Toalett];
    const toggleButtons = [Garage, Heating, Watering, Roller_Shutter, Gate, Settings, External_Lighting, Living_Lighting, Bedroom03_Lighting, Bedroom04_Lighting, Kitchen, Bathroom, Garage_Lighting, Toalett];
    
    toggleButtons.forEach(btn => {
      btn.addEventListener("click", () => {

        // √öJ: Ha a gomb le van tiltva, ne t√∂rt√©njen semmi. (A felhaszn√°l√≥ logik√°ja)
        if (btn.classList.contains("disabled")) {
          return;
        }

        const currentPresetId = activePresetId && activePresetId();

        // Ha van akt√≠v preset, √©s valaki manu√°lisan megnyom egy ikont:
        if (currentPresetId) {
          const presets = loadPresets();
          const preset = presets.find(p => p.id === currentPresetId);


          // 1) mindent OFF-ra tesz√ºnk, ami a presetben volt
          if (preset) {
            clearPresetFromUiAndNodeRed(preset);
          }

          // 2) t√∂r√∂lj√ºk az akt√≠v presetet
          setActivePresetId(null);
          renderPresetList();

          // 3) itt NEM kapcsoljuk √°t a gombot ‚Äì els≈ë katt csak "preset t√∂rl√©s"
          return;
        }

        // Ha nincs akt√≠v preset ‚Üí sima toggle mehet
        btn.classList.toggle("active");
        saveUserState(); // √öJ: Minden v√°ltoz√°s ment√©se (a felhaszn√°l√≥ k√©r√©se alapj√°n)
      });
    });

    // √öJ: SECURITY LOGIKA (a felhaszn√°l√≥ √°ltal k√ºld√∂tt)
    Security.addEventListener("click", () => {
      // Security saj√°t √°llapot√°t √°tv√°ltjuk
      Security.classList.toggle("active");
      if (Security.classList.contains("active")) {
        // SECURITY BEKAPCSOLVA:
        // minden m√°s gomb kapcsoljon ki √©s legyen tiltva
        securityControllableButtons.forEach(btn => {
          btn.classList.remove("active");  // kikapcsoljuk
          btn.classList.add("disabled");   // nem lehet r√° kattintani
        });
      } else {
        // üîì SECURITY KIKAPCSOLVA:
        // minden gomb ism√©t m≈±k√∂dhet
        securityControllableButtons.forEach(btn => {
          btn.classList.remove("disabled");
        });
      }
      saveUserState(); // Security √°llapot ment√©se
    });

    Entrence.addEventListener
      ("click", () => {
        document.body.classList.remove("outside");
        document.body.classList.add("inside");

        // Hide old button
        Garage.classList.add("hidden");
        Entrence.classList.add("hidden");
        Watering.classList.add("hidden");
        Roller_Shutter.classList.add("hidden");
        Gate.classList.add("hidden");
        Security.classList.add("hidden");
        External_Lighting.classList.add("hidden");

        // Show new buttons
        Living_Lighting.classList.remove("hidden");
        Bedroom03_Lighting.classList.remove("hidden");
        Bedroom04_Lighting.classList.remove("hidden");
        Kitchen.classList.remove("hidden");
        Bathroom.classList.remove("hidden");
        Garage_Lighting.classList.remove("hidden");
        Toalett.classList.remove("hidden");
        Back.classList.remove("hidden");
        Heating.classList.remove("hidden");
      });

    // We go back to the Exterior view
    Back.addEventListener
      ("click", () => {
        document.body.classList.remove("inside");
        document.body.classList.add("outside");

        // Hide old buttons
        Back.classList.add("hidden");
        Living_Lighting.classList.add("hidden");
        Bedroom03_Lighting.classList.add("hidden");
        Bedroom04_Lighting.classList.add("hidden"); //Ezt adtam hozza
        Kitchen.classList.add("hidden"); //Ezt adtam hozza
        Bathroom.classList.add("hidden"); //Ezt adtam hozza
        Garage_Lighting.classList.add("hidden"); //Ezt adtam hozza
        Toalett.classList.add("hidden"); //Ezt adtam hozza
        Heating.classList.add("hidden");


        // Show new buttons
        Garage.classList.remove("hidden");
        Entrence.classList.remove("hidden");
        Watering.classList.remove("hidden");
        Roller_Shutter.classList.remove("hidden");
        Gate.classList.remove("hidden");
        Security.classList.remove("hidden");
        External_Lighting.classList.remove("hidden");
      });
  </script>

  <style>
    /* --- h√°tt√©r √©s panel --- */
    .settings-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      place-items: center;
      z-index: 1000;
    }

    .settings-backdrop.show {
      display: grid;
    }

    .settings-modal {
      position: relative;
      background: #ffffff;
      color: #0f172a;
      padding: 16px;
      border-radius: 12px;
      width: 340px;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.24);
      transition: background 0.2s ease, color 0.2s ease;
    }

    .settings-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: 0;
      font-size: 20px;
      cursor: pointer;
    }

    .settings-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    html[data-theme="dark"] .settings-modal {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .6);
    }

    .hr {
      height: 1px;
      background: #e5e7eb;
      margin: 12px 0;
    }

    html[data-theme="dark"] .hr {
      background: #1f2937;
    }

    /* --- cs√∫szka --- */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background-color: #f87171;
      border-radius: 26px;
      transition: 0.3s;
    }

    .slider::before {
      content: "";
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }

    .switch input:checked+.slider {
      background-color: #4ade80;
    }

    .switch input:checked+.slider::before {
      transform: translateX(24px);
    }

    /* --- gombok --- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: 1px solid #e5e7eb;
      padding: 6px 10px;
      border-radius: 8px;
      background: #f8fafc;
      color: #0f172a;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background .2s, border-color .2s, transform .05s;
    }

    .btn:hover {
      background: #f1f5f9;
    }

    .btn:active {
      transform: translateY(1px);
    }

    html[data-theme="dark"] .btn {
      background: #0b1220;
      color: #e5e7eb;
      border-color: #1f2937;
    }

    html[data-theme="dark"] .btn:hover {
      background: #0e1729;
    }

    .btn-danger {
      color: #dc2626;
      border-color: #fecaca;
      background: #fff1f2;
    }

    .btn-danger:hover {
      background: #ffe4e6;
    }

    html[data-theme="dark"] .btn-danger {
      color: #fca5a5;
      border-color: #7f1d1d;
      background: #1b0b0b;
    }

    html[data-theme="dark"] .btn-danger:hover {
      background: #260f0f;
    }

    /* --- Preset lista --- */
    .preset-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .preset-list {
      display: grid;
      gap: 8px;
      margin-top: 8px;
    }

    .preset-item {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #ffffff;
    }

    html[data-theme="dark"] .preset-item {
      border-color: #1f2937;
      background: #0b1220;
    }

    .preset-name {
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .icon-btn {
      background: none;
      border: 0;
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
    }

    .icon-btn[title="Szerkeszt√©s"] {
      color: #2563eb;
    }

    .icon-btn[title="T√∂rl√©s"] {
      color: #dc2626;
    }

    /* --- szerkeszt≈ë panel --- */
    .editor {
      margin-top: 10px;
      padding: 10px;
      border: 1px dashed #cbd5e1;
      border-radius: 10px;
      display: none;
    }

    html[data-theme="dark"] .editor {
      border-color: #334155;
    }

    .editor.show {
      display: block;
    }

    .editor-grid {
      display: grid;
      gap: 12px;
    }

    .editor-row {
      display: grid;
      gap: 8px;
    }

    .editor-group {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px;
    }

    html[data-theme="dark"] .editor-group {
      border-color: #1f2937;
    }

    .group-title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .input {
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      color: inherit;
    }

    html[data-theme="dark"] .input {
      background: #0b1220;
      border-color: #1f2937;
      color: #e5e7eb;
    }

    /* --- logout --- */
    .logout-row {
      margin-top: 16px;
      padding-top: 10px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }

    .logout-btn {
      color: #dc2626;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 15px;
      transition: color 0.2s;
    }

    .logout-btn:hover {
      color: #b91c1c;
    }
  </style>
  </head>

  <body>
    <div id="settingsBackdrop" class="settings-backdrop">
      <div class="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <button id="settingsClose" class="settings-close" aria-label="Bez√°r√°s">√ó</button>

        <!-- T√©ma -->
        <div class="settings-row" role="group" aria-label="Theme">
          <strong>Theme:</strong>
          <label><input type="radio" name="theme" value="light" checked> Light</label>
          <label><input type="radio" name="theme" value="dark"> Dark</label>
        </div>

        <div class="settings-row" role="group" aria-label="Auto Roller Shutter">
          <strong>Auto Roller Shutter:</strong>
          <label class="switch">
            <input type="checkbox" id="autoRollerToggle">
            <span class="slider"></span>
          </label>
        </div>

        <div class="hr"></div>

        <!-- Presetek -->
        <div class="preset-header">
          <strong>Presets</strong>
          <button id="addPreset" class="btn">Ôºã New preset</button>
        </div>
        <div id="presetList" class="preset-list" aria-live="polite"></div>

        <!-- Szerkeszt≈ë -->
        <div id="presetEditor" class="editor" aria-live="polite">
          <div class="editor-grid">
            <div class="field">
              <label for="presetName"><strong>Preset name</strong></label>
              <input id="presetName" class="input" type="text" placeholder="E.g. Morning routine" maxlength="40" />
            </div>

            <div class="editor-group">
              <div class="group-title">Outdoor equipment</div>
              <div class="toggle-row"><span>Gate</span> <label class="switch"><input data-key="Gate"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>External Lighting</span> <label class="switch"><input
                    data-key="External Lighting" type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Watering</span> <label class="switch"><input data-key="Watering"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Garage</span> <label class="switch"><input data-key="Garage"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Roller Shutter</span> <label class="switch"><input data-key="Roller Shutter"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Security</span> <label class="switch"><input data-key="Security"
                    type="checkbox"><span class="slider"></span></label></div>
            </div>

            <div class="editor-group">
              <div class="group-title">Indoor lighting</div>
              <div class="toggle-row"><span>Bedroom03</span> <label class="switch"><input data-key="Bedroom03"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Bedroom04</span> <label class="switch"><input data-key="Bedroom04"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Living room</span> <label class="switch"><input data-key="Living room"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Kitchen</span> <label class="switch"><input data-key="Kitchen"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Garage</span> <label class="switch"><input data-key="Garage (inside)"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Bathroom</span> <label class="switch"><input data-key="Bathroom"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Toalett</span> <label class="switch"><input data-key="Toalett"
                    type="checkbox"><span class="slider"></span></label></div>
              <div class="toggle-row"><span>Heating</span> <label class="switch"><input data-key="Heating"
                    type="checkbox"><span class="slider"></span></label></div>
            </div>

            <div style="display:flex; gap:8px; justify-content:flex-end;">
              <button id="cancelEdit" class="btn">Cancel</button>
              <button id="savePreset" class="btn">üíæ Save</button>
            </div>
          </div>
        </div>

        <!-- Logout -->
        <div class="logout-row">
          <button id="logoutBtn" class="logout-btn">Log out</button>
        </div>
      </div>
    </div>

    <script>

      const NODE_RED_BASE = "http://127.0.0.1:1880";

      const deviceToEndpoint = {
        "Gate": "Gate",
        "External Lighting": "External_Lighting",
        "Garage": "garage",
        "Roller Shutter": "Roller_Shutter",
        "Security": "Security",

        "Heating": "Heating",
        "Bedroom03": "Bedroom03_Lighting",
        "Bedroom04": "Bedroom04_Lighting",
        "Living room": "Living_Lighting",
        "Kitchen": "Kitchen_Lighting",
        "Garage (inside)": "Garage_Lighting",
        "Bathroom": "Bathroom_Lighting",
        "Toalett": "Toalett_Lighting",
        "autoRollerToggle":"autoRollerToggle"
      };

      const deviceToElementId = {
        "Gate": "Gate",
        "External Lighting": "External_Lighting",
        "Garage": "Garage",
        "Roller Shutter": "Roller_Shutter",
        "Security": "Security",

        "Heating": "Heating",
        "Bedroom03": "Bedroom03_Lighting",
        "Bedroom04": "Bedroom04_Lighting",
        "Living room": "Living_Lighting",
        "Kitchen": "Kitchen_Lighting",
        "Garage (inside)": "Garage_Lighting",
        "Bathroom": "Bathroom_Lighting",
        "Toalett": "Toalett_Lighting"
      };

      function applyPresetToUiAndNodeRed(preset) {
        if (!preset || !preset.devices) return;

        for (const [key, isOn] of Object.entries(preset.devices)) {
          const endpoint = deviceToEndpoint[key];
          const elId = deviceToElementId[key];
          const state = isOn ? "on" : "off";

          // 1) UI friss√≠t√©s
          if (elId) {
            const el = document.getElementById(elId);
            if (el) {
              el.classList.toggle("active", isOn);
            }
          }

          // 2) Node-RED h√≠v√°s
          if (endpoint) {
            fetch(`${NODE_RED_BASE}/${endpoint}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ state })
            })
              .then(res => res.json())
              .then(data => console.log(`Preset ‚Üí ${key} = ${state}`, data))
              .catch(err => console.error(`Preset hiba: ${key}`, err));
          }
        }
      }

      // Ugyanaz, mint applyPresetToUiAndNodeRed, csak mindent OFF-ra tesz
      function clearPresetFromUiAndNodeRed(preset) {
        if (!preset || !preset.devices) return;

        for (const [key] of Object.entries(preset.devices)) {
          const endpoint = deviceToEndpoint[key];
          const elId = deviceToElementId[key];
          const state = "off";

          // 1) UI: ikon kikapcs
          if (elId) {
            const el = document.getElementById(elId);
            if (el) {
              el.classList.remove("active");
            }
          }

          // 2) Node-RED: OFF k√ºld√©s
          if (endpoint) {
            fetch(`${NODE_RED_BASE}/${endpoint}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ state })
            })
              .then(res => res.json())
              .then(data => console.log(`Preset OFF ‚Üí ${key}`, data))
              .catch(err => console.error(`Preset OFF hiba: ${key}`, err));
          }
        }
      }


      // ===== Elem hivatkoz√°sok =====
      const backdrop = document.getElementById('settingsBackdrop');
      const closeBtn = document.getElementById('settingsClose');
      const settingsBtn = document.getElementById('Settings'); // jobb fels≈ë fogasker√©k
      const themeRadios = document.querySelectorAll('input[name="theme"]');

      const presetList = document.getElementById('presetList');
      const addPresetBtn = document.getElementById('addPreset');

      const editor = document.getElementById('presetEditor');
      const presetNameInput = document.getElementById('presetName');
      const savePresetBtn = document.getElementById('savePreset');
      const cancelEditBtn = document.getElementById('cancelEdit');

      const logoutBtn = document.getElementById('logoutBtn');

      // Editor √°llapot
      let editingId = null; // null = √∫j preset

      // Alap kulcsok (fel√ºlethez k√∂tve data-key alapj√°n)
      function allDeviceKeys() {
        return Array.from(editor.querySelectorAll('input[type="checkbox"][data-key]')).map(i => i.getAttribute('data-key'));
      }

      // ===== Modal megnyit√°s / z√°r√°s =====
      settingsBtn && settingsBtn.addEventListener('click', () => {
        backdrop.classList.add('show');
        renderPresetList();
      });
      closeBtn.addEventListener('click', () => backdrop.classList.remove('show'));
      backdrop.addEventListener('click', e => { if (e.target === backdrop) backdrop.classList.remove('show'); });

      // ===== T√©ma v√°lt√°s =====
      themeRadios.forEach(radio => {
        radio.addEventListener('change', e => {
          document.documentElement.setAttribute('data-theme', e.target.value);
          localStorage.setItem('theme', e.target.value);
        });
      });

      // ===== Preset CRUD a localStorage-ben =====
      const LS_KEY = 'userPresets';
      const LS_ACTIVE = 'activePresetId';

      function loadPresets() {
        try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; }
      }
      function savePresets(list) {
        localStorage.setItem(LS_KEY, JSON.stringify(list));
      }
      function activePresetId() { return localStorage.getItem(LS_ACTIVE) || null; }
      function setActivePresetId(id) { if (id === null) localStorage.removeItem(LS_ACTIVE); else localStorage.setItem(LS_ACTIVE, id); }

      function ensureDefaults() {
        // Ha nincs semmi, l√©trehozunk k√©t mint√°t, hogy legyen mit l√°tni
        const items = loadPresets();
        if (items.length === 0) {
          const keys = allDeviceKeys();
          const sample1 = { id: crypto.randomUUID(), name: 'Reggel', devices: Object.fromEntries(keys.map(k => [k, false])) };
          const sample2 = { id: crypto.randomUUID(), name: 'Este', devices: Object.fromEntries(keys.map(k => [k, false])) };
          // P√©lda: este k√ºls≈ë vil√°g√≠t√°s √©s Security bekapcsolva
          sample2.devices['External Lighting'] = true;
          sample2.devices['Security'] = true;
          savePresets([sample1, sample2]);
          setActivePresetId(sample2.id);
        }
      }

      // ===== Lista render =====
      function renderPresetList() {
        ///ensureDefaults();
        const items = loadPresets();
        const activeId = activePresetId();
        if (items.length === 0) { presetList.innerHTML = '<em>There are no presets yet. Click on the "New preset" button!.</em>'; return; }
        presetList.innerHTML = '';
        for (const p of items) {
          const row = document.createElement('div');
          row.className = 'preset-item';
          row.dataset.id = p.id;
          row.innerHTML = `
            <div class="preset-name" title="${p.name}">${p.name}</div>
            <label class="switch" title="Activation">
              <input type="checkbox" ${p.id === activeId ? 'checked' : ''} aria-label="Activation">
              <span class="slider"></span>
            </label>
            <button class="icon-btn" title="Edit">‚úé</button>
            <button class="icon-btn" title="Delete">üóë</button>
          `;
          presetList.appendChild(row);
        }
      }

      // ===== Preset szerkeszt≈ë =====
      function openEditor(preset) {
        editingId = preset ? preset.id : null;
        // N√©v
        presetNameInput.value = preset ? preset.name : '';
        // Kapcsol√≥k
        const allKeys = allDeviceKeys();
        const devices = preset ? preset.devices : Object.fromEntries(allKeys.map(k => [k, false]));
        for (const input of editor.querySelectorAll('input[type="checkbox"][data-key]')) {
          const key = input.getAttribute('data-key');
          input.checked = !!devices[key];
        }
        editor.classList.add('show');
        presetNameInput.focus();
      }

      function closeEditor() {
        editor.classList.remove('show');
        editingId = null;
      }

      function collectEditorData() {
        const name = (presetNameInput.value || '').trim();
        const devices = {};
        for (const input of editor.querySelectorAll('input[type="checkbox"][data-key]')) {
          devices[input.getAttribute('data-key')] = input.checked;
        }
        return { name, devices };
      }

      // ===== Esem√©nyek =====
      addPresetBtn.addEventListener('click', () => openEditor(null));
      cancelEditBtn.addEventListener('click', closeEditor);

      savePresetBtn.addEventListener('click', () => {
        const { name, devices } = collectEditorData();
        if (!name) { alert('Give the preset a name!'); return; }
        const list = loadPresets();
        if (editingId) {
          const idx = list.findIndex(p => p.id === editingId);
          if (idx !== -1) list[idx] = { ...list[idx], name, devices };
        } else {
          list.push({ id: crypto.randomUUID(), name, devices });
        }
        savePresets(list);
        renderPresetList();
        closeEditor();
      });

      // Lista gombjai (deleg√°ci√≥)
      presetList.addEventListener('click', (e) => {
        const row = e.target.closest('.preset-item');
        if (!row) return;
        const id = row.dataset.id;
        const list = loadPresets();
        const preset = list.find(p => p.id === id);

        // Aktiv√°l√°s kapcsol√≥
        // Aktiv√°l√°s kapcsol√≥
        if (e.target.matches('input[type="checkbox"]')) {
          const checked = e.target.checked;

          if (checked) {
            // BEKAPCSOLT PRESET
            setActivePresetId(id);
            dispatchPresetApplied(preset);   // ez ON-ra teszi, amit kell
          } else {
            // KIKAPCSOLT PRESET ‚Üí mindent OFF-ra tesz√ºnk, ami benne volt
            const activeId = activePresetId();
            if (activeId === id) {
              clearPresetFromUiAndNodeRed(preset);
              setActivePresetId(null);
            }
          }

          renderPresetList();
          return;
        }

        // Szerkeszt√©s
        if (e.target.matches('.icon-btn[title="Edit"]')) {
          openEditor(preset);
          return;
        }

        // T√∂rl√©s
        if (e.target.matches('.icon-btn[title="Delete"]')) {
          if (confirm('Are you sure you want to delete the preset?')) {
            const newList = list.filter(p => p.id !== id);
            savePresets(newList);
            if (activePresetId() === id) setActivePresetId(null);
            renderPresetList();
          }
          return;
        }
      });

      function dispatchPresetApplied(preset) {
        const event = new CustomEvent('presetApplied', { detail: { preset } });
        window.dispatchEvent(event);

        console.log('Preset applied:', preset.name, preset.devices);

        applyPresetToUiAndNodeRed(preset);
      }

      // ===== Log out gomb =====
      logoutBtn.addEventListener('click', () => {
        if (!confirm('Are you sure you want to log out?')) return;

        // Bejelentkez√©ssel kapcsolatos dolgok t√∂rl√©se
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('loggedInUser');
        localStorage.removeItem('authToken');
        localStorage.removeItem('userPresets');
        localStorage.removeItem('activePresetId');
        localStorage.removeItem('theme');

        sessionStorage.clear();

        // Visszair√°ny√≠t√°s a login oldalra
        window.location.href = 'Login_Reg.html';
      });

      // ===== Indul√≥ be√°ll√≠t√°s =====
      (function init() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        const themeRadio = document.querySelector(`input[name="theme"][value="${theme}"]`);
        if (themeRadio) themeRadio.checked = true;
        renderPresetList();

        fetch('http://127.0.0.1:1880/Settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })

        fetch('http://127.0.0.1:1880/garage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })

        // Roller Shutter auto √°llapot friss√≠t√©se
        updateRollerShutterAutoState();
      })();
    </script>
    <script>

      // Node-RED nek kuldes:
      // Settings

      Settings.addEventListener("click", () => {
        Settings.classList.toggle("active");
        const state = Settings.classList.contains("active") ? "on" : "off";

        // Modal megnyit√°sa amikor ON-ra v√°lt
        if (state === "on") {
          settingsBackdrop.classList.add("open");
        }

        fetch('http://127.0.0.1:1880/Settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())  // <-- JSON kell!
          .then(data => console.log('Node-RED v√°lasz:', data))
          .catch(err => console.error('Hiba a Node-RED h√≠v√°sban:', err));
      });

      function closeSettings() {
        // UI: gomb kikapcsol√°sa
        Settings.classList.remove("active");

        // Modal elrejt√©se
        settingsBackdrop.classList.remove("open");

        // Node-RED OFF k√ºld√©se
        fetch('http://127.0.0.1:1880/Settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state: "off" })
        })
          .then(res => res.json())
          .then(data => console.log("Settings OFF:", data))
          .catch(err => console.error("OFF hiba:", err));
      }

      // Bez√°r√≥ X gomb
      settingsClose.addEventListener("click", () => {
        closeSettings();
      });

      // H√°tt√©rre kattint√°s
      settingsBackdrop.addEventListener("click", (e) => {
        if (e.target === settingsBackdrop) {
          closeSettings();
        }
      });

      // ESC bez√°r√°s
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && settingsBackdrop.classList.contains("open")) {
          closeSettings();
        }
      });
      function sendStateToNodeRed(device, state) {
      fetch(`http://127.0.0.1:1880/${device}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state })
      })
      .then(res => res.json())
      .then(data => console.log(`${device} √°llapot elk√ºldve:`, data))
      .catch(err => console.error(`${device} hiba:`, err));
      }


      Garage.addEventListener("click", () => {
        const state = Garage.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/garage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Node-RED v√°lasz:', data))
          .catch(err => console.error('Hiba a Node-RED h√≠v√°sban:', err));
      });

      Entrence.addEventListener("click", () => {
        Entrence.classList.toggle("active");
        const state = Entrence.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Entrence', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Node-RED v√°lasz:', data))
          .catch(err => console.error('Fetch hiba:', err));
      });

      document.getElementById('Watering').addEventListener('click', () => {
        fetch('http://127.0.0.1:1880/Watering', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'pressed' })
        })
          .then(res => res.json())
          .then(data => console.log('Node-RED v√°lasz:', data))
          .catch(err => console.error('Fetch hiba:', err));
      });

      Roller_Shutter.addEventListener("click", () => {
        const state = Roller_Shutter.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Roller_Shutter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Node-RED v√°lasz:', data))
          .catch(err => console.error('Hiba a Node-RED h√≠v√°sban:', err));
      });

      Gate.addEventListener("click", () => {
        const state = Gate.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Gate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Gate v√°lasz:', data))
          .catch(err => console.error('Gate hiba:', err));
      });

      Security.addEventListener("click", () => {
        // Active classot NEM toggoljuk itt, azt az els≈ë script m√°r elint√©zi
        const state = Security.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Security', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Security v√°lasz:', data))
          .catch(err => console.error('Security hiba:', err));
      });

      External_Lighting.addEventListener("click", () => {
        // Active class togglinget az els≈ë script v√©gzi, itt csak olvassuk az √°llapotot
        const state = External_Lighting.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/External_Lighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('External Lighting v√°lasz:', data))
          .catch(err => console.error('External Lighting hiba:', err));
      });

      document.getElementById('Back').addEventListener('click', () => {
        // 1) UI: Entrence gomb kikapcsol√°sa
        Entrence.classList.remove("active");

        // 2) Node-RED-nek sz√≥lunk, hogy Entrence = OFF
        fetch('http://127.0.0.1:1880/Entrence', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state: 'off' })
        })
          .then(res => res.json())
          .then(data => console.log('Entrence OFF v√°lasz:', data))
          .catch(err => console.error('Entrence OFF hiba:', err));

        // 3) Megy a saj√°t Back endpoint is (navig√°ci√≥, egyebek)
        fetch('http://127.0.0.1:1880/Back', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'pressed' })
        })
          .then(res => res.json())
          .then(data => console.log('Back v√°lasz:', data))
          .catch(err => console.error('Back hiba:', err));
      });

      // LIVING LIGHTING
      Living_Lighting.addEventListener("click", () => {
        const state = Living_Lighting.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Living_Lighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Living_Lighting v√°lasz:', data))
          .catch(err => console.error('Living_Lighting hiba:', err));
      });

      // BEDROOM03 LIGHTING
      Bedroom03_Lighting.addEventListener("click", () => {
        const state = Bedroom03_Lighting.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Bedroom03_Lighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Bedroom03_Lighting v√°lasz:', data))
          .catch(err => console.error('Bedroom03_Lighting hiba:', err));
      });

      // BEDROOM04 LIGHTING
      Bedroom04_Lighting.addEventListener("click", () => {
        const state = Bedroom04_Lighting.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Bedroom04_Lighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Bedroom04_Lighting v√°lasz:', data))
          .catch(err => console.error('Bedroom04_Lighting hiba:', err));
      });

      // KITCHEN LIGHTING
      Kitchen_Lighting.addEventListener("click", () => {
        const state = Kitchen_Lighting.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Kitchen_Lighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Kitchen_Lighting v√°lasz:', data))
          .catch(err => console.error('Kitchen_Lighting hiba:', err));
      });

      // BATHROOM LIGHTING
      Bathroom_Lighting.addEventListener("click", () => {
        const state = Bathroom_Lighting.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Bathroom_Lighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Bathroom_Lighting v√°lasz:', data))
          .catch(err => console.error('Bathroom_Lighting hiba:', err));
      });

      // GARAGE (INSIDE) LIGHTING
      Garage_Lighting.addEventListener("click", () => {
        const state = Garage_Lighting.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Garage_Lighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Garage_Lighting v√°lasz:', data))
          .catch(err => console.error('Garage_Lighting hiba:', err));
      });

      // TOALETT LIGHTING
      Toalett_Lighting.addEventListener("click", () => {
        const state = Toalett_Lighting.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Toalett_Lighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Toalett_Lighting v√°lasz:', data))
          .catch(err => console.error('Toalett_Lighting hiba:', err));
      });

      // HEATING
      Heating.addEventListener("click", () => {
        const state = Heating.classList.contains("active") ? "on" : "off";

        fetch('http://127.0.0.1:1880/Heating', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        })
          .then(res => res.json())
          .then(data => console.log('Heating v√°lasz:', data))
          .catch(err => console.error('Heating hiba:', err));
      });
    </script>
    <script>

    const autoRollerToggle = document.getElementById('autoRollerToggle');
    const autoLabel = document.querySelector('#Roller_Shutter .auto-label');

    function updateRollerShutterAutoState() {
      if (autoRollerToggle.checked) {
        // Auto bekapcsolva ‚Üí gomb deaktiv√°lva
        Roller_Shutter.classList.remove("active"); // kikapcsoljuk a manu√°lis √°llapotot
        Roller_Shutter.classList.add("disabled");  // letiltjuk
        autoLabel.classList.remove("hidden");      // label l√°that√≥
      } else {
        // Auto kikapcsolva ‚Üí gomb √∫jra haszn√°lhat√≥
        Roller_Shutter.classList.remove("disabled");
        autoLabel.classList.add("hidden");        // label elrejtve
      }
    }

    // Esem√©ny kezel≈ë
    autoRollerToggle.addEventListener('change', updateRollerShutterAutoState);

    // Init √°llapot bet√∂lt√©se
    updateRollerShutterAutoState();

    //Auto Roller Shutter √°llapot k√ºld√©se Node-RED-nek
    autoRollerToggle.addEventListener("click", () => {
    const state = autoRollerToggle.checked ? "on" : "off";

    fetch('http://127.0.0.1:1880/autoRollerToggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state })
    })
    .then(res => res.json())
    .then(data => console.log('Auto Roller v√°lasz:', data))
    .catch(err => console.error('Auto Roller hiba:', err));
    });
  </script>
  </body>